MACRO(CHECK_FOR_FILES DIR DOWNLOAD_NEEDED)
  IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR}/ZA001000)
    SET(${DOWNLOAD_NEEDED} TRUE)
  ENDIF()

  IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR}/ZA006000)
    SET(${DOWNLOAD_NEEDED} TRUE)
  ENDIF()

  IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR}/ZA013000)
    SET(${DOWNLOAD_NEEDED} TRUE)
  ENDIF()

  IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR}/ZA013000)
    SET(${DOWNLOAD_NEEDED} TRUE)
  ENDIF()

  IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR}/ZA014000)
    SET(${DOWNLOAD_NEEDED} TRUE)
  ENDIF()

  IF(NOT EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR}/ZA082000)
    SET(${DOWNLOAD_NEEDED} TRUE)
  ENDIF()
ENDMACRO()

MACRO(FIND_ENDL_FILES DIR)
  FIND_FILE(${DIR}1  ZA001000 ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
  FIND_FILE(${DIR}6  ZA006000 ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
  FIND_FILE(${DIR}13 ZA013000 ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
  FIND_FILE(${DIR}14 ZA014000 ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
  FIND_FILE(${DIR}82 ZA082000 ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
ENDMACRO()

SET(DOWNLOAD_NEEDED FALSE)

CHECK_FOR_FILES(eadl DOWNLOAD_NEEDED)
CHECK_FOR_FILES(epdl DOWNLOAD_NEEDED)
CHECK_FOR_FILES(eedl DOWNLOAD_NEEDED)

IF(DOWNLOAD_NEEDED)
  SET(ENDL_DOWNLOADER endl_downloader.sh)
 
  EXECUTE_PROCESS(COMMAND ${PYTHON_EXECUTABLE} ${CMAKE_SOURCE_DIR}/scripts/endl_downloader.py -l "H,C,Al,Si,Pb"
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
    OUTPUT_FILE ${ENDL_DOWNLOADER}
    RESULT_VARIABLE RETURN_CODE)

  IF(NOT "${RETURN_CODE}" STREQUAL "0")
    MESSAGE(FATAL_ERROR "Could not generate the ${ENDL_DOWNLOADER} script!" )
  ENDIF()

  MESSAGE("-- Downloading ENDL data used for testing")
  
  EXECUTE_PROCESS(COMMAND bash ${ENDL_DOWNLOADER} -d ./ -l
    WORKING_DIRECTORY ${CMAKE_CURRENT_BINARY_DIR}
    ERROR_FILE endl_download_log.txt
    RESULT_VARIABLE RETURN_CODE)
  
  IF(NOT "${RETURN_CODE}" STREQUAL "0")
    MESSAGE(FATAL_ERROR "Could not download the ENDL data!")
  ENDIF()

  FIND_ENDL_FILES(eadl)
  FIND_ENDL_FILES(epdl)
  FIND_ENDL_FILES(eedl)
ENDIF()
